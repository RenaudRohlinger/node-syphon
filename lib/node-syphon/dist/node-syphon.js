"use strict";var e=Object.defineProperty,r=(r,s,t)=>(((r,s,t)=>{s in r?e(r,s,{enumerable:!0,configurable:!0,writable:!0,value:t}):r[s]=t})(r,"symbol"!=typeof s?s+"":s,t),t);Object.defineProperty(exports,Symbol.toStringTag,{value:"Module"});const s=require("bindings"),t=require("child_process"),i=require("path"),o=require("url"),n=s({bindings:"syphon",try:[["module_root","node_modules","node-syphon","dist","bin","syphon.node"],["module_root","dist","bin","syphon.node"]]});const h=i.dirname(o.fileURLToPath("undefined"==typeof document?require("url").pathToFileURL(__filename).href:document.currentScript&&document.currentScript.src||new URL("node-syphon.js",document.baseURI).href)),a=`node ${i.join(h,"server-directory-process.js")}`,p=["exit","SIGINT","SIGUSR1","SIGUSR2","SIGQUIT","SIGSEGV","uncaughtException","SIGTERM"];var c=(e=>(e.SyphonServerInfoNotification="syphon:server.info",e.SyphonServerErrorNotification="syphon:server.error",e.SyphonServerAnnounceNotification="syphon:server.announce",e.SyphonServerRetireNotification="syphon:server.retire",e.SyphonServerUpdateNotification="syphon:server.update",e))(c||{});const y="NodeSyphonMessageInfo",v="NodeSyphonMessageError",_="NodeSyphonMessageNotification",d=class e{constructor(){if(r(this,"_serverDirectoryProcess"),r(this,"_serverDirectoryRunning",!1),r(this,"_servers",[]),r(this,"_listeners",{}),e._instance)return e._instance;e._instance=this}dispose(){this.removeAllListeners(),this._serverDirectoryProcess&&(this._serverDirectoryProcess.kill(),this._serverDirectoryProcess=null,this._servers.length=0,this._serverDirectoryRunning=!1)}on(e,r){this._listeners[e]||(this._listeners[e]=[]),this._listeners[e].push(r)}off(e,r){if(this._listeners[e]){const s=this._listeners[e].find((e=>e==r));if(s){const r=this._listeners[e].indexOf(s);this._listeners[e].splice(r,1)}}}removeAllListeners(){for(const e in this._listeners)this._listeners[e].length=0}get isRunning(){return this._serverDirectoryRunning}get servers(){return this._servers}listen(){try{if(this._serverDirectoryRunning)return;this._handleExit(),this._serverDirectoryProcess=t.exec(a),this._emit("syphon:server.info",`Syphon directory server process launched with pid: ${this._serverDirectoryProcess.pid}`),this._serverDirectoryProcess.stdout.setEncoding("utf8"),this._serverDirectoryProcess.stdout.on("data",this._parseProcessData.bind(this)),this._serverDirectoryRunning=!0}catch(e){throw this._emit("syphon:server.error",e),this.dispose(),e}}_emit(e,r){if(this._listeners[e])for(const s of this._listeners[e])s(r)}_parseProcessData(e){try{const r=e.toString().split("--__node-syphon-delimiter__--");let s=[];for(const e of r)0!==e.trim().length&&s.push(JSON.parse(e));for(const e of s)switch(e.NodeSyphonMessageType){case y:this._emit("syphon:server.info",e.NodeSyphonMessage);break;case v:this._emit("syphon:server.error",e.NodeSyphonMessage);break;case _:switch(e.NodeSyphonMessage.NodeSyphonNotificationType){case"SyphonServerAnnounceNotification":this._servers.push(e.NodeSyphonMessage.NodeSyphonServerDictionary),this._servers=Array.from(new Set(this._servers)),this._emit("syphon:server.announce",e.NodeSyphonMessage.NodeSyphonServerDictionary);break;case"SyphonServerRetireNotification":{const r=this._servers.find((r=>r.SyphonServerDescriptionUUIDKey==e.NodeSyphonMessage.NodeSyphonServerDictionary.SyphonServerDescriptionUUIDKey));if(r){const s=this._servers.indexOf(r);this._servers.splice(s,1),this._emit("syphon:server.retire",e.NodeSyphonMessage.NodeSyphonServerDictionary)}break}case"SyphonServerUpdateNotification":{const r=this._servers.find((r=>r.SyphonServerDescriptionUUIDKey==e.NodeSyphonMessage.NodeSyphonServerDictionary.SyphonServerDescriptionUUIDKey));if(r){const s=this._servers.indexOf(r);this._servers.splice(s,1,e.NodeSyphonMessage.NodeSyphonServerDictionary),this._emit("syphon:server.update",e.NodeSyphonMessage.NodeSyphonServerDictionary)}break}}break;default:throw new Error(`Unhandled message type from ServerDirectory subprocess: ${e.NodeSyphonMessageType}`)}}catch(r){throw r}}_handleExit(){process.stdin.resume(),p.forEach((e=>{const r=()=>{this._serverDirectoryProcess&&(this.dispose(),p.forEach((e=>{process.off(e,r)})))};process.on(e,r)}))}};r(d,"_instance");let S=d;exports.NodeSyphonMessageKey="NodeSyphonMessage",exports.NodeSyphonMessageTypeError=v,exports.NodeSyphonMessageTypeInfo=y,exports.NodeSyphonMessageTypeKey="NodeSyphonMessageType",exports.NodeSyphonMessageTypeNotification=_,exports.NodeSyphonNotificationTypeKey="NodeSyphonNotificationType",exports.NodeSyphonServerDictionaryKey="NodeSyphonServerDictionary",exports.SyphonMetalServer=class{constructor(e){r(this,"_server"),this._server=new n.MetalServer(e)}dispose(){this._server.dispose()}publishImageData(e,r,s,t){this._server.publishImageData(e,r,s,t)}get name(){return this._server.name}get serverDescription(){return this._server.serverDescription}get hasClients(){return this._server.hasClients}},exports.SyphonOpenGLClient=class{constructor(e){r(this,"_client"),r(this,"_onFrameListeners"),r(this,"_frameInterval"),this._client=new n.OpenGLClient(e),this._onFrameListeners=[]}dispose(){this._frameInterval&&clearInterval(this._frameInterval),this._onFrameListeners.length=0,this._client.dispose()}on(e,r){if("frame"===e)this._frameInterval||(this._frameInterval=setInterval((async()=>{for(const e of this._onFrameListeners){e(await this._client.newFrame())}}),1e3/60)),this._onFrameListeners.push(r)}off(e,r){if("frame"===e){const e=this._onFrameListeners.find((e=>e===r));if(e){const r=this._onFrameListeners.indexOf(e);this._onFrameListeners.splice(r,1)}0===this._onFrameListeners.length&&clearInterval(this._frameInterval)}}get newFrame(){return this._client.newFrame()}get width(){return this._client.width}get height(){return this._client.height}},exports.SyphonOpenGLServer=class{constructor(e){r(this,"_server"),this._server=new n.OpenGLServer(e)}dispose(){this._server.dispose()}publishImageData(e,r,s,t,i){this._server.publishImageData(e,r,s,t,i)}get name(){return this._server.name}get serverDescription(){return this._server.serverDescription}get hasClients(){return this._server.hasClients}},exports.SyphonServerDirectory=S,exports.SyphonServerDirectoryListenerChannel=c;
